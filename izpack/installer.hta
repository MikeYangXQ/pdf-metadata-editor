<html>
<head>
  <title>Check java version</title>
    <hta:application id="pmeditJavaCheck"
     applicationname="PdfMetadataEditorJavaCheck"
     border=""
     borderstyle="normal"
     caption="yes"
     icon=""
     maximizebutton=""
     minimizebutton="yes"
     showintaskbar="yes"
     singleinstance="no"
     sysmenu="yes"
     version="1.0"
     windowstate=""/>
     <style type="text/css">
 #mainTable {
   margin-top: auto;
   margin-right: auto;
   margin-bottom: auto;
   margin-left: auto;
   padding-top: 0px;
   padding-right: 0px;
   padding-bottom: 0px;
   padding-left: 0px;
 }

 #actionButton {
   width: 70%;
   height: 70%;
 }
 #theBody {
   background-color: #cccccc;
   padding-top: 0px;
   padding-right: 0px;
   padding-bottom: 0px;
   padding-left: 0px;
 }
 #message {
  font-size: x-large;
}
 </style>

  <script language="JavaScript">
window.resizeTo(640,480);
var JAVAWEXE="javaw.exe";
var jarInstaller = "${project.build.finalName}.jar";
var shell = new ActiveXObject("WScript.shell");
var java = {};

var argRE = [
  /^"[^"]+"\s+"([^"]+)"/,
  /^"[^"]+"\s+(\S+)/,
];

for(var i in argRE){
  var found = pmeditJavaCheck.commandLine.match(argRE[i]);
  if(found){
    jarInstaller = found[1];
    break;
  }
}


function execCmd(cmd, onCompleted){
  var oExec = shell.exec(cmd);
  var timerId = setInterval(function () {
    if(oExec.Status != 0) {
      if(onCompleted){
        onCompleted();
      }
      clearInterval(timerId);
    }
  }, 1000);
}


function getJava(){
  var j={};
  var javaHome, javaExe;

  var env = shell.Environment("System")
  javaHome = env("JAVA_HOME");

  if(javaHome) {
      var regpath = "HKLM\\SOFTWARE\\JavaSoft\\Java Runtime Environment\\";
      try {
        var version = shell.RegRead(regpath + "CurrentVersion");
        javaHome = shell.RegRead(regpath + version + "\\JavaHome");
      } catch(e) {}
  }

  if(!javaHome) {
    var output = "";
    try {
      var oExec = shell.exec("where " + JAVAWEXE);
      while (oExec.Status == 0) {
        if (!oExec.StdOut.AtEndOfStream){
          output += oExec.StdOut.ReadAll();
        }
      }
      var rtrim = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;
      output = output.replace(rtrim, '')
    } catch(e) {}

    if (output.length) {
      javaExe = output;
    }
  }

  if( javaHome ) {
    j.javaHome = javaHome;
    j.javaExe = javaHome + '\\bin\\' + JAVAWEXE;
  } else if (javaExe) {
    j.javaExe = javaExe;
  }

  return j;
}

function installJRE(){
  actionButton.disabled = true
  actionButton.innerText = "Running..."
  execCmd("JavaSetup.exe SPONSORS=0", function () {
    actionButton.disabled = false
    init()
  });
}

function startInstaller() {
  actionButton.disabled = true
  actionButton.innerText = "Running..."
  execCmd(java.javaExe + " -jar " + jarInstaller, function () {
    actionButton.disabled = false
    window.close()
  });
}

function init() {
  java = getJava();
  if (java.javaExe) {
    message.innerText = "Java found"
    actionButton.innerText = "Begin Install"
    actionButton.onclick = startInstaller
  } else {
    message.innerText = "Java not found."
    actionButton.innerText = "Install Java Runtime Environment"
    actionButton.onclick = installJRE
  }

}

function window.onload() {
  init();
}
  </script>
</head>
<body scroll="no" id="theBody">
  <table style="width: 600px; height: 400px;" border="0">
    <tbody>
      <tr align="center" style="height: 60%">
        <td id="message"><br>
        </td>
      </tr>
      <tr  style="height: 40%">
        <td style="text-align: center;"><button id="actionButton" value="Begin Install" name="actionButton">Begin Install</button><br>
        </td>
      </tr>
    </tbody>
  </table>

</body>
</html>
